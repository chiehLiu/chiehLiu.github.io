<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="author" content="Chieh Liu"><title>JS-閉包(Closure) | Chieh Liu&#39;s Blog</title><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script src="/js/script.js"></script><script src="/js/tocbot.min.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Chieh Liu's Blog" type="application/atom+xml">
</head><body><div class="wrapper"><header><nav class="navbar"><div class="container"><div class="navbar-header header-logo"><a href="/">Chieh Liu&#39;s Blog</a></div><div class="menu navbar-right"><a class="menu-item" href="/archives">Posts</a> <a class="menu-item" href="/category">Categories</a> <a class="menu-item" href="/tag">Tags</a> <a class="menu-item" href="/about">About</a> <input id="switch_default" type="checkbox" class="switch_default"> <label for="switch_default" class="toggleBtn"></label></div></div></nav><nav class="navbar-mobile" id="nav-mobile"><div class="container"><div class="navbar-header"><div><a href="/">Chieh Liu&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a></div><div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div></div><div class="menu" id="mobile-menu"><a class="menu-item" href="/archives">Posts</a> <a class="menu-item" href="/category">Categories</a> <a class="menu-item" href="/tag">Tags</a> <a class="menu-item" href="/about">About</a></div></div></nav></header><script>var mobileBtn=function(){var e=document.getElementsByClassName("menu-toggle")[0],t=document.getElementById("mobile-menu");e.classList.contains("active")?(e.classList.remove("active"),t.classList.remove("active")):(e.classList.add("active"),t.classList.add("active"))}</script><div class="main"><div class="container"><div class="post-toc"><div class="tocbot-list"></div><div class="tocbot-list-menu"><a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a> <a onclick="go_top()">Back to top</a> <a onclick="go_bottom()">Go to bottom</a></div></div><script>function expand_toc(){var o=document.querySelector(".tocbot-toc-expand");tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:6,orderedList:!1,scrollSmooth:!0}),o.setAttribute("onclick","collapse_toc()"),o.innerHTML="Collapse all"}function collapse_toc(){var o=document.querySelector(".tocbot-toc-expand");tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:1,orderedList:!1,scrollSmooth:!0}),o.setAttribute("onclick","expand_toc()"),o.innerHTML="Expand all"}function go_top(){window.scrollTo(0,0)}function go_bottom(){window.scrollTo(0,document.body.scrollHeight)}document.ready((function(){tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:1,orderedList:!1,scrollSmooth:!0})}))</script><article class="post-wrap"><header class="post-header"><h1 class="post-title">JS-閉包(Closure)</h1><div class="post-meta">Author: <a itemprop="author" rel="author" href="/">Chieh Liu</a> <span class="post-time">Date: <a href="#">April 11, 2021&nbsp;&nbsp;23:32:12</a> </span><span class="post-category">Category: <a href="/categories/Javascript/">Javascript</a></span></div></header><div class="post-content"><h1 id="閉包-Closure"><a href="#閉包-Closure" class="headerlink" title="閉包(Closure)"></a>閉包(Closure)</h1><p>在理解閉包之前需要先理解</p><ul><li>自由變數(全域變數)</li><li>作用域鍊 scope chain</li><li>靜態作用域 static scope（lexical scope）</li><li>動態作用域 dynamic scope</li></ul><h1 id="作用域（Scope）"><a href="#作用域（Scope）" class="headerlink" title="作用域（Scope）"></a>作用域（Scope）</h1><blockquote><p>「作用域就是一個變數的生存範圍，一旦出了這個範圍，就無法存取到這個變數」</p></blockquote><h2 id="範例-區域變數"><a href="#範例-區域變數" class="headerlink" title="範例 - 區域變數"></a>範例 - 區域變數</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">10</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(a)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 印出結果:  Uncaught ReferenceError: a is not defined</span></span><br></pre></td></tr></table></figure><p>這裡因為a的作用域存在於function test裡面所以無法被印出</p><h3 id="把區域變數變成全域變數"><a href="#把區域變數變成全域變數" class="headerlink" title="把區域變數變成全域變數"></a>把區域變數變成全域變數</h3><p>JS 裡有一種狀況會自動產生全域變數，那就是賦值給未宣告的變數</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            n = <span class="number">10</span>; <span class="comment">//n直接轉變成全域變數</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;hello&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        test()</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(n);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">test2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(n + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        test2();</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">window</span>.n); <span class="comment">// 從這段可以明白n是全域變數</span></span><br><span class="line"><span class="comment">// hello , 10, 11, 10</span></span><br></pre></td></tr></table></figure><h2 id="範例-全域變數"><a href="#範例-全域變數" class="headerlink" title="範例 - 全域變數"></a>範例 - 全域變數</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> I_am_global = <span class="number">123</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(I_am_global) </span><br><span class="line">&#125;</span><br><span class="line">test()</span><br><span class="line"><span class="comment">// 印出結果:123</span></span><br></pre></td></tr></table></figure><p>這邊的變數會寫在global裡面稱為全域變數任何地方都可以存取到它</p><h2 id="小練習"><a href="#小練習" class="headerlink" title="小練習"></a>小練習</h2><p>這邊test()會印出100或是200?</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">100</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">echo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a) <span class="comment">// 100 or 200?</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">200</span></span><br><span class="line">  echo()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test()</span><br></pre></td></tr></table></figure><p>很混淆對嗎?</p><p>但是只要明白:</p><ol><li>當函式內部找不到變數使用時會往外部找</li><li>這邊的練習echo的外部就是global並不是test()</li><li>因此答案是100</li></ol><h1 id="靜態作用域（static-scope）"><a href="#靜態作用域（static-scope）" class="headerlink" title="靜態作用域（static scope）"></a>靜態作用域（static scope）</h1><blockquote><p>代表作用域跟這個 function 在哪裡被「呼叫」一點關係都沒有，你用肉眼看程式碼的結構就可以看出來它的作用域是什麼，而且是不會變的。</p></blockquote><p>以小練習的範例說明的話:</p><ol><li>在test裡面另外宣告了a 並且呼叫了它</li><li>但是因為靜態作用域的影響 function 被宣告時就被決定了它的外部環境也就是全域變數</li><li>所以執行階段的出現的a 變數(test內)並沒有影響其值</li><li>但是如果JS採用的是動態作用域的話印出結果就會是200</li></ol><h1 id="閉包（Closure）"><a href="#閉包（Closure）" class="headerlink" title="閉包（Closure）"></a>閉包（Closure）</h1><h2 id="範例說明閉包"><a href="#範例說明閉包" class="headerlink" title="範例說明閉包"></a>範例說明閉包</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> my_balance = <span class="number">999</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deduct</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">  my_balance -= (n &gt; <span class="number">10</span> ? <span class="number">10</span> : n) <span class="comment">// 超過 10 塊只扣 10 塊</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">deduct(<span class="number">13</span>) <span class="comment">// 只被扣 10 塊</span></span><br><span class="line">my_balance -= <span class="number">999</span> <span class="comment">// 還是被扣了 999 塊</span></span><br></pre></td></tr></table></figure><p>就算我們函式操作好每次扣的金額，但是因為變數在全域範圍，因此任何人都可以取用這個時候就可以使用閉包</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getWallet</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> my_balance = <span class="number">999</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    deduct: <span class="function"><span class="keyword">function</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">      my_balance -= (n &gt; <span class="number">10</span> ? <span class="number">10</span> : n) <span class="comment">// 超過 10 塊只扣 10 塊</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">var</span> wallet = getWallet()</span><br><span class="line">wallet.deduct(<span class="number">13</span>) <span class="comment">// 只被扣 10 塊</span></span><br><span class="line">my_balance -= <span class="number">999</span> <span class="comment">// Uncaught ReferenceError: my_balance is not defined</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>這邊透過return的方式把函式包在另一個函式內部的物件內，透過這樣的方式想要修改變數my_balance就會失敗搂！這樣的使用方式就是<strong>閉包</strong></p><h2 id="範例說明閉包二"><a href="#範例說明閉包二" class="headerlink" title="範例說明閉包二"></a>範例說明閉包二</h2><p>假設html有五個按鈕</p><p>點擊按鈕後會得出甚麼結果?</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> btn = <span class="built_in">document</span>.querySelectorAll(<span class="string">&#x27;button&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;= <span class="number">4</span>; i++) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(i);</span><br><span class="line">            btn[i].addEventListener(<span class="string">&#x27;click&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                alert(i)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>結果是都是5，並不是預期中0,1,2,3,4</p><p>原因如下:</p><ol><li>事件會從stack被丟入web API 做處理</li><li>所以這邊console.log(i)就已經先印出0~4了</li><li>迴圈跑到5的時候跳出迴圈這時候事件的部分也從event loop回來接受i的資料</li><li>因此印出的內容都是5</li></ol><p>解決方式:</p><p>使用let代替var，每次跑回圈都會產生新的作用域，因此alert出來就會是想要的值了</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;=<span class="number">4</span>; i++) &#123;</span><br><span class="line">  btn[i].addEventListener(<span class="string">&#x27;click&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(i)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><section class="post-copyright"></section><section class="post-tags"><div><span>Tag(s):</span> <span class="tag"><a href="/tags/Javascript/"># Javascript</a></span></div><div><a href="javascript:window.history.back();">back</a> <span>· </span><a href="/">home</a></div></section><section class="post-nav"><a class="prev" rel="prev" href="/2021/04/11/JS-this%20%E6%98%AF%E4%BB%80%E9%BA%BC/">JS-this 是什麼</a> <a class="next" rel="next" href="/2021/04/07/JS-%E8%AE%8A%E6%95%B8%E6%8F%90%E5%8D%87(Hoisting)/">JS-變數提升(Hoisting)</a></section></article></div></div><footer id="footer" class="footer"><div class="copyright"><span>© Chieh Liu | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span></div></footer></div></body></html>